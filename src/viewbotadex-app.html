<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../personnal_components/botadex-element/botadex-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="viewbotadex-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px 20px;
      }
    </style>
    <template is="dom-if" if="[[user]]">

      <template is="dom-repeat" items="[[allSpecies]]" id="listBotadex">
        <div>
          <span><botadex-element prop1="[[item.firstSpecie]]" disco="[[discoS]]" apply="[[isReady]]"></botadex-element></span><span>///</span><span><botadex-element prop1="[[item.secondSpecie]]" disco="[[discoS]]" apply="[[isReady]]"></botadex-element></span>
        </div>
      </template>

    </template>

    <template is="dom-if" if="[[!user]]">
      <h4 style="color:red">Veuillez vous connecter afin de consulter le BotaDex</h4>
    </template>

    <firebase-auth
      app-name="iPreleveFirebase"
      id="auth"
      provider="google">
    </firebase-auth>
  </template>

  <script>
    Polymer({
      is: 'viewbotadex-app',

      properties: {
        discoS:{
          type:Array,
          value:[],
        },
        allSpecies:{
          type:Array,
          value:[],
        },
        doAdded:{
          type:Boolean,
          value:true
        },
        userId:{
          type:String,
          value:""
        },
        numberSpecies:{
          type:Number,
          readOnly:true
        },
        isReady:{
          type:Boolean,
          value:false,
        }
      },

      observers:[
        "allSpeciesCheck(allSpecies.length)",
      ],

      numberSpeciesHandler: function(number){
        this._setNumberSpecies(number);
      },

      ready: function(){
        const numberOfSpecies = 199;
        this.numberSpeciesHandler(199);

        this.$.auth.addEventListener("signed-in-changed",function(e){
          if(this.user){
            //Connexion
            this.createOns();
          }else{
            //DÃ©connexion
            this.doOffs();
          }
        }.bind(this));
      },

      createOns: function(){
        this.userId = this.user.uid;
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/discoveredSpecies").on("child_added", snapshot=>{
          if(this.doAdded){
            this.push("discoS", snapshot.key);
            this.notifyPath("discoS");
            this.notifyPath("allSpecies");
            //this.shadowRoot.querySelector("#listSpecies").render();
          }
        });

        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/discoveredSpecies").on("child_removed", oldChildSnapshot=>{
          if(this.doAdded){
            if(this.discoS.includes(oldChildSnapshot.key)){
              this.splice("discoS", this.discoS.indexOf(oldChildSnapshot.key), 1);
              this.notifyPath("discoS");
              this.notifyPath("allSpecies");
              //this.shadowRoot.querySelector("#listSpecies").render();
            }
          }
        });

        firebase.app("iPreleveFirebase").database().ref("/species").on("child_added", snapshot=>{
          if(this.doAdded){
            this.push("allSpecies", snapshot.key);
            this.notifyPath("allSpecies");
            //this.shadowRoot.querySelector("#listSpecies").render();
          }
        })
      },

      doOffs: function(){
        this.splice("discoS", 0, this.discoS.length);
        this.notifyPath("discoS");
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.userId+"/discoveredSpecies").off();
        this.userId = "";

        this.splice("allSpecies", 0, this.allSpecies.length);
        this.notifyPath("allSpecies");
        //this.shadowRoot.querySelector("#listSpecies").render();
      },

      hasDiscoveredSpecie: function(item){
        return this.discoS.includes(item);
      },

      styleSpecie: function(item, number){
        if(!number && item.secondSpecie != undefined && item.secondSpecie != null){
          if(this.hasDiscoveredSpecie(item.firstSpecie)){
            return "color:green";
          }else{
            return "color:red";
          }
        }else if(number && item.secondSpecie != undefined && item.secondSpecie != null){
          if(this.hasDiscoveredSpecie(item.secondSpecie)){
            return "color:green";
          }else{
            return "color:red";
          }
        }else{
          if(this.hasDiscoveredSpecie(item.firstSpecie)){
            return "color:green";
          }else{
            return "color:red";
          }
        }

      },

      allSpeciesCheck(length){
        if(length === this.numberSpecies){
          this.rearrangeAllSpecieArrayDisposition();
          this.isReady = true;
        }
      },

      rearrangeAllSpecieArrayDisposition: function(){
        var newArray = [];
        for(var i = 0; i < this.allSpecies.length ; i++){
          var objectTwoSpecies = {};
          if(i%2){
            objectTwoSpecies.firstSpecie = this.allSpecies[i-1];
            objectTwoSpecies.secondSpecie = this.allSpecies[i];
            newArray.push(objectTwoSpecies);
          }
        }

        if(newArray.length != ((this.allSpecies.length)/2)){
          var lastSpecie = {firstSpecie : this.allSpecies[(this.allSpecies.length)-1]};
          newArray.push(lastSpecie);
        }

        this.allSpecies = newArray;
        this.notifyPath("allSpecies");
        //this.shadowRoot.querySelector("#listSpecies").render();
      },
    });
  </script>
</dom-module>
