<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="shared-styles.html">

<dom-module id="viewbotadex-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px 20px;
      }
    </style>
    <template is="dom-if" if="[[user]]">
      <h4>Liste des espèces obtenues</h4>
      <template is="dom-repeat" items="[[discoS]]">
        [[item]]
      </template>

      <paper-listbox>
        <template is="dom-repeat" items="[[allSpecies]]" id="listSpecies">
          <paper-item><span style$="[[styleSpecie(item)]]">[[item]]</span></paper-item>
        </template>
      </paper-listbox>

    </template>

    <template is="dom-if" if="[[!user]]">
      <h4 style="color:red">Veuillez vous connecter afin de consulter vos relevés</h4>
    </template>

    <firebase-auth
      app-name="iPreleveFirebase"
      id="auth"
      provider="google">
    </firebase-auth>
  </template>

  <script>
    Polymer({
      is: 'viewbotadex-app',

      properties: {
        discoS:{
          type:Array,
          value:[],
        },
        allSpecies:{
          type:Array,
          value:[],
        },
        doAdded:{
          type:Boolean,
          value:true
        },
        userId:{
          type:String,
          value:""
        }
      },

      ready: function(){
        this.$.auth.addEventListener("signed-in-changed",function(e){
          if(this.user){
            //Connexion
            this.createOns();
          }else{
            //Déconnexion
            this.doOffs();
          }
        }.bind(this));
      },

      createOns: function(){
        this.userId = this.user.uid;
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/discoveredSpecies").on("child_added", snapshot=>{
          if(this.doAdded){
            this.push("discoS", snapshot.key);
            this.notifyPath("discoS");
            this.shadowRoot.querySelector("#listSpecies").render();
          }
        });

        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.user.uid+"/discoveredSpecies").on("child_removed", oldChildSnapshot=>{
          if(this.doAdded){
            if(this.discoS.includes(oldChildSnapshot.key)){
              this.splice("discoS", this.discoS.indexOf(oldChildSnapshot.key), 1);
              this.notifyPath("discoS");
              this.shadowRoot.querySelector("#listSpecies").render();
            }
          }
        });

        firebase.app("iPreleveFirebase").database().ref("/species").on("child_added", snapshot=>{
          if(this.doAdded){
            this.push("allSpecies", snapshot.key);
            this.notifyPath("allSpecies");
            this.shadowRoot.querySelector("#listSpecies").render();
          }
        })
      },

      doOffs: function(){
        this.splice("discoS", 0, this.discoS.length);
        this.notifyPath("discoS");
        firebase.app("iPreleveFirebase").database().ref("/releves/"+this.userId+"/discoveredSpecies").off();
        this.userId = "";

        this.splice("allSpecies", 0, this.allSpecies.length);
        this.notifyPath("allSpecies");
      },

      hasDiscoveredSpecie: function(item){
        return this.discoS.includes(item);
      },

      styleSpecie: function(item){
        if(this.hasDiscoveredSpecie(item)){
          return "color:green";
        }else{
          return "color:red";
        }
      },



    });
  </script>
</dom-module>
